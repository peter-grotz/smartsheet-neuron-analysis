#!/usr/bin/env bash
set -ex

# Code Ocean App Builder Run Script
# Converts positional arguments to command line arguments for app_analysis.py

# Arguments from App Builder (positional):
# $1 = soma_location (required)
# $2 = hive_filter (boolean: "true" or "false") 
# $3 = plot_format (string: "svg", "png", "html")
# $4 = save_csv (boolean: "true" or "false")
# $5 = create_plots (boolean: "true" or "false")

echo "Code Ocean - Smartsheet Neuron Reconstruction Analysis"
echo "========================================================"
echo "App Builder Mode - Processing parameters..."

# Required parameter
SOMA_LOCATION="$1"
if [ -z "$SOMA_LOCATION" ]; then
    echo "Error: soma_location parameter is required"
    exit 1
fi

# Build command arguments
CMD_ARGS="--soma-location $SOMA_LOCATION"

# Optional: HIVE filter
if [ "$2" = "true" ]; then
    CMD_ARGS="$CMD_ARGS --hive-filter"
fi

# Optional: Plot format
if [ -n "$3" ]; then
    CMD_ARGS="$CMD_ARGS --plot-format $3"
fi

# Optional: Save CSV (default true, so add --no-csv if false)
if [ "$4" = "false" ]; then
    CMD_ARGS="$CMD_ARGS --no-csv"
fi

# Optional: Create plots (default true, so add --no-plots if false)  
if [ "$5" = "false" ]; then
    CMD_ARGS="$CMD_ARGS --no-plots"
fi

echo "Running with arguments: $CMD_ARGS"
echo ""

# Check if we're in Code Ocean (has /results directory)
if [ -d "/results" ]; then
    echo "Code Ocean environment detected - outputs will go to /results"
    export OUTPUT_DIR="/results"
else
    echo "Local environment - outputs will go to outputs/"
    mkdir -p outputs
    export OUTPUT_DIR="outputs"
fi

# Run the analysis
python /code/app_analysis.py $CMD_ARGS 